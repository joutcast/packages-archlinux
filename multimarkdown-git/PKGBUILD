# Contributor: Felix Hanley <felix@seconddrawer.com.au>
# Contributor: John K. Luebs <jkluebs@luebsphoto.com>


pkgname=multimarkdown-git
pkgver=20120721
pkgrel=22
pkgdesc="Expanded version of John Gruber's original Markdown"
makedepends=('git' 'glib2')
optdepends=('texlive-most: latex and PDF output support')
url="https://github.com/fletcher/peg-multimarkdown"
license=('GPL2')
arch=('x86_64')
provides=('multimarkdown')
conflicts=('multimarkdown')

_gitroot="git://github.com/fletcher/peg-multimarkdown.git"
_gitname="multimarkdown"

build() {
    cd $srcdir

    msg "Connecting to GIT server..."
    if [[ -d $_gitname ]]; then
        (cd $_gitname && git pull origin master)
    else
        git clone $_gitroot $_gitname
    fi
    msg "GIT checkout done or server timeout"

    cd "${_gitname}"
    ./update_submodules.sh
    make

    # make just html documentation
    cd documentation
    ../Support/Utilities/mmd_merge.pl index.txt > manual.txt
    mkdir -p ../manual
    ../multimarkdown manual.txt > ../manual/index.html
    cp -p *.png ../manual


}

package() {
    mkdir -p $startdir/pkg/usr/bin
    mkdir -p $startdir/pkg/usr/share/doc/multimarkdown-git
    cd "${srcdir}/${_gitname}"

    install -Dm755 $_gitname \
        scripts/mmd2tex \
        scripts/mmd2pdf \
        scripts/mmd2opml \
        scripts/mmd2odf \
        scripts/mmd2all \
        $startdir/pkg/usr/bin/

    install -Dm755 Support/bin/opml2tex \
        Support/bin/mmd2ODF.pl
    cp -dpR manual $startdir/pkg/usr/share/doc/multimarkdown-git
    chmod -R 0755 $startdir/pkg/usr/share/doc/multimarkdown-git
}

